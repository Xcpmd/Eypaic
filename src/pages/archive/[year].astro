---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { siteConfig } from '../../config';
import indexCSS from '../../styles/index.css?raw';
import '../../styles/index.css';
import '../../styles/global.css';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  
  // 获取所有年份
  const years = new Set(
    posts.map(post => (post.data.pubDate || post.data.date).getFullYear())
  );
  
  return Array.from(years).map(year => ({
    params: { year: year.toString() },
    props: { year, posts: posts.filter(post => (post.data.pubDate || post.data.date).getFullYear() === year) }
  }));
}

export const prerender = true;

const { year, posts } = Astro.props;

// 格式化日期
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};

// 按月份分组
const groupByMonth = (posts: any[]) => {
  const groups: Record<string, any[]> = {};
  
  // 检查posts是否存在且为数组
  if (!posts || !Array.isArray(posts)) {
    return groups;
  }
  
  posts.forEach(post => {
    // 检查post和post.data是否存在
    if (!post || !post.data || !(post.data.pubDate || post.data.date)) {
      return;
    }
    
    const postDate = post.data.pubDate || post.data.date;
    const month = postDate.getMonth();
    const monthName = new Date(2023, month).toLocaleString('zh-CN', { month: 'long' });
    
    if (!groups[monthName]) {
      groups[monthName] = [];
    }
    
    groups[monthName].push(post);
  });
  
  return groups;
};

const postsByMonth = groupByMonth(posts);
---

<Layout title={`归档 - ${year}年`} description={`${year}年所有文章归档`}>
  <!-- 主要内容区域 -->
  <section class="content-section">
    <div class="container">
      <div class="main-column">
        <!-- 归档信息卡片 -->
        <div class="archive-card base-card fade-in">
          <div class="archive-header">
            <h1 class="archive-title">{year}年归档</h1>
            <p class="archive-description">共 {posts?.length || 0} 篇文章</p>
          </div>
        </div>

        <!-- 归档内容 -->
        <div class="archive-content-card base-card fade-in">
          <h2 class="section-title">文章列表</h2>
          {Object.entries(postsByMonth).map(([month, monthPosts]) => (
            <div class="archive-month">
              <h3 class="month-title">{month}</h3>
              <div class="posts-list">
                {monthPosts.map(post => (
                  <article class="post-item">
                    <div class="post-meta">
                      <time class="post-date" datetime={(post.data.pubDate || post.data.date).toISOString()}>
                        {formatDate(post.data.pubDate || post.data.date).replace(`${year}年`, '')}
                      </time>
                    </div>
                    <h3 class="post-title">
                      <a href={`/posts/${post.slug}`}>{post.data.title}</a>
                    </h3>
                    {post.data.tags && Array.isArray(post.data.tags) && post.data.tags.length > 0 && (
                      <div class="tags">
                        {post.data.tags.map(tag => (
                          <a href={`/tags/${tag}`} class="tag">#{tag}</a>
                        ))}
                      </div>
                    )}
                  </article>
                ))}
              </div>
            </div>
          ))}
        </div>

        <!-- 导航 -->
        <div class="navigation-card base-card fade-in">
          <div class="archive-navigation">
            <a href="/archive" class="nav-link">← 返回归档首页</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <style is:global>{indexCSS}</style>
  
  <!-- 归档页面特定样式 -->
  <style>
    .archive-card {
      max-width: 800px;
      margin: 0 auto;
      margin-top: -2rem;
      padding: 2rem;
      text-align: center;
    }
    
    .archive-title {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .archive-description {
      font-size: 1.2rem;
      color: var(--text-color);
      opacity: 0.8;
    }
    
    .archive-content-card {
      max-width: 800px;
      margin: 0 auto;
      margin-top: 2rem;
      padding: 2rem;
    }
    
    .archive-month {
      margin-bottom: 2rem;
    }
    
    .month-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary-color);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .post-date {
      font-size: 0.9rem;
      color: var(--text-color);
      opacity: 0.7;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    .navigation-card {
      max-width: 800px;
      margin: 0 auto;
      margin-top: 2rem;
      padding: 1.5rem;
    }
    
    .archive-navigation {
      text-align: center;
    }
    
    .nav-link {
      display: inline-block;
      color: var(--text-color);
      text-decoration: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    .nav-link:hover {
      background-color: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      .archive-card {
        padding: 1.5rem;
        margin-top: -1.5rem;
      }
      
      .archive-title {
        font-size: 2rem;
      }
      
      .archive-description {
        font-size: 1rem;
      }
      
      .archive-content-card {
        padding: 1.5rem;
        margin-top: 1.5rem;
      }
      
      .section-title {
        font-size: 1.3rem;
      }
      
      .month-title {
        font-size: 1.3rem;
        margin-bottom: 0.8rem;
      }
      
      .post-item {
        margin-bottom: 1rem;
      }
      
      .post-title {
        font-size: 1.1rem;
      }
      
      .tag {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
      }
      
      .navigation-card {
        padding: 1rem;
        margin-top: 1.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .archive-card {
        padding: 1rem;
        margin-top: -1rem;
      }
      
      .archive-title {
        font-size: 1.8rem;
      }
      
      .archive-description {
        font-size: 0.95rem;
      }
      
      .archive-content-card {
        padding: 1rem;
        margin-top: 1rem;
      }
      
      .section-title {
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
      }
      
      .archive-month {
        margin-bottom: 1.5rem;
      }
      
      .month-title {
        font-size: 1.2rem;
        margin-bottom: 0.6rem;
      }
      
      .post-item {
        margin-bottom: 0.8rem;
        padding-bottom: 0.8rem;
      }
      
      .post-date {
        font-size: 0.8rem;
        margin-bottom: 0.4rem;
      }
      
      .post-title {
        font-size: 1rem;
        line-height: 1.4;
      }
      
      .post-title a {
        padding: 0;
      }
      
      .tags {
        margin-top: 0.5rem;
      }
      
      .tag {
        font-size: 0.75rem;
        padding: 0.15rem 0.4rem;
      }
      
      .navigation-card {
        padding: 0.8rem;
        margin-top: 1rem;
      }
      
      .nav-link {
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
      }
    }
  </style>
</Layout>